<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Minecraft Server Controller v4.2</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px;
}
h1, h2 {
  text-align: center;
}
.section {
  margin: 20px 0;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
}
.new-feature {
  border: 2px solid #28a745;
  background-color: #f0fff4;
}
.new-badge {
  display: inline-block;
  background-color: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-left: 10px;
}
button {
  margin: 5px;
  padding: 8px 16px;
  cursor: pointer;
}
input[type="text"], input[type="number"], select {
  width: 80%;
  padding: 6px;
  margin: 5px 0;
}
textarea {
  width: 100%;
  height: 220px;
  margin-top: 10px;
  white-space: pre-wrap;
}
pre {
  background: #f7f7f7;
  padding: 10px;
  border-radius: 6px;
  max-height: 300px;
  overflow: auto;
}
.status-running {
  color: green;
  font-weight: bold;
}
.status-stopped {
  color: red;
  font-weight: bold;
}
.small {
  font-size: 0.85em;
  color: #666;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table th, table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
table th {
  background-color: #f2f2f2;
}
.btn-danger {
  background-color: #dc3545;
  color: white;
  border: none;
}
.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
}
.btn-primary {
  background-color: #007bff;
  color: white;
  border: none;
}
.hidden {
  display: none;
}
.stat-card {
  display: inline-block;
  background: #f8f9fa;
  padding: 10px 15px;
  margin: 5px;
  border-radius: 5px;
  border: 1px solid #dee2e6;
}
.stat-value {
  font-size: 1.5em;
  font-weight: bold;
  color: #007bff;
}
</style>
</head>

<body>

<h1>ğŸŸ© Minecraft Server Controller v4.2</h1>
<p style="text-align:center" class="small">âœ¨ v1.3.9 New Features: Player Stats, Performance Monitoring, Chat Logs, Templates</p>

<!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åç™»éŒ² -->
<div class="section" id="playerRegisterSection">
<h2>ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²</h2>
<p>åˆã‚ã¦ã®æ–¹ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„</p>
<input type="text" id="playerNameInput" placeholder="Minecraftãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<select id="roleSelect">
  <option value="player">Playerï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</option>
  <option value="admin">Adminï¼ˆç®¡ç†è€…ï¼‰</option>
</select>
<button onclick="registerPlayer()" class="btn-success">ç™»éŒ²ã—ã¦APIã‚­ãƒ¼å–å¾—</button>
<p id="registerResult"></p>
</div>

<!-- API KEY -->
<div class="section">
<h2>ğŸ”‘ API Key</h2>
<input type="text" id="apiKeyInput" placeholder="X-API-Key">
<button onclick="saveKey()">ä¿å­˜</button>
<button onclick="loadMyInfo()">è‡ªåˆ†ã®æƒ…å ±ã‚’ç¢ºèª</button>
<p class="small">â€» localStorageã«ä¿å­˜ã•ã‚Œã¾ã™</p>
<div id="myInfo"></div>
</div>

<!-- Server Control -->
<div class="section">
<h2>âš™ Server Control</h2>
<button onclick="control('start')">Start</button>
<button onclick="control('stop')">Stop</button>
<button onclick="getStatus()">Status</button>
<p id="status">Status: Unknown</p>
</div>

<!-- ========== v1.3.9 æ–°æ©Ÿèƒ½ ========== -->

<!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆ -->
<div class="section new-feature">
<h2>ğŸ“Š Player Statistics<span class="new-badge">NEW v1.3.9</span></h2>
<p class="small">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ—ãƒ¬ã‚¤æ™‚é–“ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã€ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚’ç¢ºèª</p>
<input type="text" id="statsPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="getPlayerStats()" class="btn-primary">çµ±è¨ˆã‚’è¡¨ç¤º</button>
<button onclick="getAllPlayerStats()" class="btn-primary">å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
<div id="playerStatsResult"></div>
</div>

<!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° -->
<div class="section new-feature">
<h2>âš¡ Performance Monitoring<span class="new-badge">NEW v1.3.9</span></h2>
<p class="small">ã‚µãƒ¼ãƒãƒ¼ã®TPSã€ãƒ¡ãƒ¢ãƒªã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</p>
<button onclick="getCurrentPerformance()" class="btn-primary">ç¾åœ¨ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</button>
<button onclick="getPerformanceHistory()" class="btn-primary">å±¥æ­´ï¼ˆéå»1æ™‚é–“ï¼‰</button>
<div id="performanceResult"></div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆãƒ­ã‚° -->
<div class="section new-feature">
<h2>ğŸ’¬ Chat Logs<span class="new-badge">NEW v1.3.9</span></h2>
<p class="small">ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®é–²è¦§ãƒ»æ¤œç´¢</p>
<button onclick="getRecentChat()" class="btn-primary">æœ€è¿‘ã®ãƒãƒ£ãƒƒãƒˆ</button>
<input type="text" id="chatSearchInput" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
<button onclick="searchChat()" class="btn-primary">æ¤œç´¢</button>
<input type="text" id="chatPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="getPlayerChat()" class="btn-primary">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥</button>
<button onclick="getChatStats()" class="btn-primary">çµ±è¨ˆ</button>
<div id="chatLogsResult"></div>
</div>

<!-- ã‚³ãƒãƒ³ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
<div class="section new-feature">
<h2>ğŸ“ Command Templates<span class="new-badge">NEW v1.3.9</span></h2>
<p class="small">ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ä¿å­˜</p>
<p class="small">â€» ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼UUIDãŒå¿…è¦ã§ã™ï¼ˆã‚²ãƒ¼ãƒ å†…ã§ /msc template ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰</p>
<button onclick="getTemplates()" class="btn-primary">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§</button>
<div id="templatesResult"></div>
<hr>
<h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ</h3>
<input type="text" id="templatePlayerUUID" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼UUIDï¼ˆä¾‹: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxï¼‰">
<input type="text" id="templateName" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå">
<input type="text" id="templateCommand" placeholder="ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹: /give {player} {item} {amount}ï¼‰">
<input type="text" id="templateDesc" placeholder="èª¬æ˜ï¼ˆä»»æ„ï¼‰">
<button onclick="createTemplate()" class="btn-success">ä½œæˆ</button>
<p id="templateResult"></p>
</div>

<!-- ========== æ—¢å­˜æ©Ÿèƒ½ ========== -->

<!-- Whitelist ç®¡ç† -->
<div class="section">
<h2>ğŸ“‹ Whitelist ç®¡ç†</h2>
<input type="text" id="whitelistPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="whitelistAdd()" class="btn-success">è¿½åŠ </button>
<button onclick="whitelistRemove()" class="btn-danger">å‰Šé™¤</button>
<button onclick="whitelistEnable()" class="btn-success">æœ‰åŠ¹åŒ–</button>
<button onclick="whitelistDisable()" class="btn-danger">ç„¡åŠ¹åŒ–</button>
<button onclick="loadWhitelist()">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
<p id="whitelistResult"></p>
<div id="whitelistList"></div>
</div>

<!-- Operator ç®¡ç† -->
<div class="section">
<h2>ğŸ‘‘ Operator ç®¡ç†</h2>
<p class="small">â€» ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</p>
<input type="text" id="opPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="opAdd()" class="btn-success">OPä»˜ä¸</button>
<button onclick="opRemove()" class="btn-danger">OPå‰Šé™¤</button>
<p id="opResult"></p>
</div>

<!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† -->
<div class="section">
<h2>ğŸ”Œ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ï¼ˆPAPER/SPIGOTç”¨ï¼‰</h2>
<p class="small">â€» ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</p>
<button onclick="loadPlugins()">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§</button>
<button onclick="reloadPlugins()">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒ­ãƒ¼ãƒ‰</button>
<div id="pluginsList"></div>
<hr>
<h3>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
<input type="file" id="pluginFileInput" accept=".jar">
<button onclick="uploadPlugin()" class="btn-success">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
<p id="pluginResult"></p>
</div>

<!-- Console -->
<div class="section">
<h2>ğŸ’» Server Console</h2>
<input type="text" id="cmdInput" placeholder="ä¾‹: say Hello">
<button onclick="sendCommand()">Send</button>
<button onclick="loadHistory()">Load History</button>
<textarea id="cmdOutput" readonly></textarea>
</div>

<!-- Upload -->
<div class="section">
<h2>ğŸ“¦ Upload File / Folder</h2>
<input type="file" id="fileInput" webkitdirectory directory multiple>
<button onclick="upload()">Upload</button>
<p id="uploadResult"></p>
</div>

<!-- Backup -->
<div class="section">
<h2>ğŸ’¾ Backup Management</h2>

<!-- æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
<h3>æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
<button onclick="backup()">Create Backup Now</button>
<p id="backupResult"></p>

<!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ -->
<h3>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§</h3>
<button onclick="loadBackups()">Refresh</button>
<div id="backupsList"></div>

<!-- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
<h3>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆç®¡ç†è€…å°‚ç”¨ï¼‰</h3>
<p class="small">â€» cronå½¢å¼: "åˆ† æ™‚ æ—¥ æœˆ æ›œæ—¥" (ä¾‹: "0 2 * * *" = æ¯æ—¥2æ™‚)</p>
<input type="text" id="scheduleName" placeholder="ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å (ä¾‹: daily)">
<input type="text" id="cronExpression" placeholder="cronå¼ (ä¾‹: 0 2 * * *)">
<input type="number" id="maxBackups" placeholder="ä¿æŒä¸–ä»£æ•°" value="7" min="1">
<button onclick="createSchedule()" class="btn-success">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ</button>
<p id="scheduleResult"></p>

<h3>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§</h3>
<button onclick="loadSchedules()">Refresh</button>
<div id="schedulesList"></div>
</div>

<!-- Logs -->
<div class="section">
<h2>ğŸ“œ Minecraft Logs</h2>
<button onclick="getLogs()">Refresh</button>
<textarea id="logsResult" readonly></textarea>
</div>

<!-- Metrics -->
<div class="section">
<h2>ğŸ“Š Server Metrics</h2>
<button onclick="getMetrics()">Load</button>
<pre id="metricsResult"></pre>
</div>

<!-- API Keys ç®¡ç†ï¼ˆRootç”¨ï¼‰ -->
<div class="section" id="apiKeysSection">
<h2>ğŸ” API Keys ç®¡ç†ï¼ˆRootå°‚ç”¨ï¼‰</h2>
<button onclick="loadApiKeys()">APIã‚­ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º</button>
<div id="apiKeysList"></div>
</div>

<!-- Audit Logs -->
<div class="section">
<h2>ğŸ•µ æ“ä½œãƒ­ã‚°ï¼ˆAudit Logsï¼‰</h2>
<button onclick="getAuditLogs()">Load</button>
<pre id="auditResult">root API Key ã§ã®ã¿è¡¨ç¤ºå¯èƒ½</pre>
</div>

<!-- Players -->
<div class="section">
  <h2>ğŸ§‘â€ğŸ’» Players</h2>
  <button onclick="loadPlayers()">Load Online Players</button>
  <select id="playerSelect" onchange="showPlayerDetail()">
    <option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>
  </select>
  <pre id="playerDetail"></pre>
</div>

<script>
const API = "http://localhost:8000";

// DOM Elements
const apiKeyInput = document.getElementById("apiKeyInput");
const playerNameInput = document.getElementById("playerNameInput");
const roleSelect = document.getElementById("roleSelect");
const registerResult = document.getElementById("registerResult");
const myInfo = document.getElementById("myInfo");
const whitelistPlayerInput = document.getElementById("whitelistPlayerInput");
const whitelistResult = document.getElementById("whitelistResult");
const whitelistList = document.getElementById("whitelistList");
const opPlayerInput = document.getElementById("opPlayerInput");
const opResult = document.getElementById("opResult");
const pluginFileInput = document.getElementById("pluginFileInput");
const pluginsList = document.getElementById("pluginsList");
const pluginResult = document.getElementById("pluginResult");
const cmdInput = document.getElementById("cmdInput");
const cmdOutput = document.getElementById("cmdOutput");
const fileInput = document.getElementById("fileInput");
const uploadResult = document.getElementById("uploadResult");
const backupResult = document.getElementById("backupResult");
const backupsList = document.getElementById("backupsList");
const scheduleName = document.getElementById("scheduleName");
const cronExpression = document.getElementById("cronExpression");
const maxBackups = document.getElementById("maxBackups");
const scheduleResult = document.getElementById("scheduleResult");
const schedulesList = document.getElementById("schedulesList");
const logsResult = document.getElementById("logsResult");
const metricsResult = document.getElementById("metricsResult");
const auditResult = document.getElementById("auditResult");
const statusEl = document.getElementById("status");
const playerSelect = document.getElementById("playerSelect");
const playerDetail = document.getElementById("playerDetail");
const apiKeysList = document.getElementById("apiKeysList");

// v1.3.9 æ–°æ©Ÿèƒ½ç”¨
const statsPlayerInput = document.getElementById("statsPlayerInput");
const playerStatsResult = document.getElementById("playerStatsResult");
const performanceResult = document.getElementById("performanceResult");
const chatSearchInput = document.getElementById("chatSearchInput");
const chatPlayerInput = document.getElementById("chatPlayerInput");
const chatLogsResult = document.getElementById("chatLogsResult");
const templatePlayerUUID = document.getElementById("templatePlayerUUID");
const templateName = document.getElementById("templateName");
const templateCommand = document.getElementById("templateCommand");
const templateDesc = document.getElementById("templateDesc");
const templateResult = document.getElementById("templateResult");
const templatesResult = document.getElementById("templatesResult");

// ========= API Key =========
function apiKey() { return localStorage.getItem("apiKey")||""; }
function headers() { return { "X-API-Key": apiKey() }; }
function headersWithUUID(uuid) { 
  return { 
    "X-API-Key": apiKey(),
    "X-Player-UUID": uuid
  }; 
}
function saveKey() {
  const key = apiKeyInput.value.trim();
  if(!key) return alert("API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  localStorage.setItem("apiKey", key);
  alert("API Key saved");
  loadMyInfo();
}

// ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ² =========
async function registerPlayer() {
  const playerName = playerNameInput.value.trim();
  const role = roleSelect.value;
  
  if (!playerName) {
    alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  const rootKey = prompt("Root API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  if (!rootKey) return;
  
  try {
    const res = await fetch(`${API}/auth/keys`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Key": rootKey
      },
      body: JSON.stringify({
        player_name: playerName,
        role: role
      })
    });
    
    if (!res.ok) {
      throw new Error("API Keyä½œæˆå¤±æ•—: Rootæ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    registerResult.innerHTML = `
      <strong>ç™»éŒ²å®Œäº†ï¼</strong><br>
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: ${data.player_name}<br>
      Role: ${data.role}<br>
      API Key: <code>${data.api_key}</code><br>
      <small>â€» ã“ã®APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ï¼ˆå†è¡¨ç¤ºã§ãã¾ã›ã‚“ï¼‰</small>
    `;
    registerResult.style.color = "green";
    
    apiKeyInput.value = data.api_key;
  } catch (err) {
    registerResult.innerText = err.message;
    registerResult.style.color = "red";
  }
}

// ========= è‡ªåˆ†ã®æƒ…å ±ç¢ºèª =========
async function loadMyInfo() {
  if (!apiKey()) {
    myInfo.innerText = "";
    return;
  }
  
  try {
    const res = await fetch(`${API}/auth/keys/my`, { headers: headers() });
    if (!res.ok) throw new Error("èªè¨¼å¤±æ•—");
    
    const data = await res.json();
    myInfo.innerHTML = `
      <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong><br>
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: ${data.player_name || "ç®¡ç†è€…"}<br>
      Role: ${data.role}
    `;
  } catch (err) {
    myInfo.innerText = "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

// ========= v1.3.9: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆ =========
async function getPlayerStats() {
  const player = statsPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/stats/player/${player}`, { headers: headers() });
    if (!res.ok) throw new Error("çµ±è¨ˆå–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    let html = `<h3>${data.player_name} ã®çµ±è¨ˆ</h3>`;
    html += `<div class="stat-card">
      <div class="small">ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“</div>
      <div class="stat-value">${data.total_playtime_hours}æ™‚é–“</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
      <div class="stat-value">${data.total_sessions}å›</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">åˆå›ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="small">${new Date(data.first_join).toLocaleString()}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="small">${new Date(data.last_join).toLocaleString()}</div>
    </div>`;
    
    if (data.recent_activity.length > 0) {
      html += `<h4>æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h4><table>
        <tr><th>ãƒ­ã‚°ã‚¤ãƒ³</th><th>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</th><th>æ™‚é–“</th></tr>`;
      data.recent_activity.forEach(a => {
        html += `<tr>
          <td>${new Date(a.login).toLocaleString()}</td>
          <td>${a.logout ? new Date(a.logout).toLocaleString() : 'ç¾åœ¨ãƒ—ãƒ¬ã‚¤ä¸­'}</td>
          <td>${a.duration_minutes ? a.duration_minutes + 'åˆ†' : '-'}</td>
        </tr>`;
      });
      html += `</table>`;
    }
    
    playerStatsResult.innerHTML = html;
  } catch (err) {
    playerStatsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function getAllPlayerStats() {
  try {
    const res = await fetch(`${API}/stats/players`, { headers: headers() });
    if (!res.ok) throw new Error("çµ±è¨ˆå–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      playerStatsResult.innerHTML = "<p>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
      return;
    }
    
    let html = `<h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ—ãƒ¬ã‚¤æ™‚é–“é †ï¼‰</h3><table>
      <tr><th>é †ä½</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</th><th>ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“</th><th>ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</th><th>æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³</th></tr>`;
    
    data.forEach((p, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td>${p.player_name}</td>
        <td>${p.total_playtime_hours}æ™‚é–“</td>
        <td>${p.total_sessions}å›</td>
        <td>${new Date(p.last_join).toLocaleString()}</td>
      </tr>`;
    });
    
    html += `</table>`;
    playerStatsResult.innerHTML = html;
  } catch (err) {
    playerStatsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

// ========= v1.3.9: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦– =========
async function getCurrentPerformance() {
  try {
    const res = await fetch(`${API}/performance/current`, { headers: headers() });
    if (!res.ok) throw new Error("ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.message) {
      performanceResult.innerHTML = `<p>${data.message}</p>`;
      return;
    }
    
    let html = `<h3>ç¾åœ¨ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>`;
    html += `<div class="stat-card">
      <div class="small">TPS</div>
      <div class="stat-value" style="color: ${data.tps >= 18 ? 'green' : data.tps >= 15 ? 'orange' : 'red'}">${data.tps.toFixed(2)}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</div>
      <div class="stat-value">${data.memory_percent.toFixed(1)}%</div>
      <div class="small">${data.memory_used_mb} / ${data.memory_total_mb} MB</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°</div>
      <div class="stat-value">${data.entities}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ãƒãƒ£ãƒ³ã‚¯æ•°</div>
      <div class="stat-value">${data.chunks}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</div>
      <div class="stat-value">${data.players}</div>
    </div>`;
    html += `<p class="small">æ›´æ–°: ${new Date(data.timestamp).toLocaleString()}</p>`;
    
    performanceResult.innerHTML = html;
  } catch (err) {
    performanceResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function getPerformanceHistory() {
  try {
    const res = await fetch(`${API}/performance/history?hours=1`, { headers: headers() });
    if (!res.ok) throw new Error("å±¥æ­´å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      performanceResult.innerHTML = "<p>å±¥æ­´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
      return;
    }
    
    let html = `<h3>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å±¥æ­´ï¼ˆéå»1æ™‚é–“ï¼‰</h3><table>
      <tr><th>æ™‚åˆ»</th><th>TPS</th><th>ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡</th><th>ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£</th><th>ãƒãƒ£ãƒ³ã‚¯</th></tr>`;
    
    // æœ€æ–°10ä»¶ã‚’è¡¨ç¤º
    data.slice(-10).forEach(p => {
      html += `<tr>
        <td>${new Date(p.timestamp).toLocaleTimeString()}</td>
        <td style="color: ${p.tps >= 18 ? 'green' : p.tps >= 15 ? 'orange' : 'red'}">${p.tps.toFixed(2)}</td>
        <td>${p.memory_percent.toFixed(1)}%</td>
        <td>${p.entities}</td>
        <td>${p.chunks}</td>
      </tr>`;
    });
    
    html += `</table><p class="small">å…¨${data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ</p>`;
    performanceResult.innerHTML = html;
  } catch (err) {
    performanceResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

// ========= v1.3.9: ãƒãƒ£ãƒƒãƒˆãƒ­ã‚° =========
async function getRecentChat() {
  try {
    const res = await fetch(`${API}/chat/recent?limit=30`, { headers: headers() });
    if (!res.ok) throw new Error("ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      chatLogsResult.innerHTML = "<p>ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>";
      return;
    }
    
    let html = `<h3>æœ€è¿‘ã®ãƒãƒ£ãƒƒãƒˆï¼ˆ${data.length}ä»¶ï¼‰</h3><table>
      <tr><th>æ™‚åˆ»</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>ãƒ¯ãƒ¼ãƒ«ãƒ‰</th><th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th></tr>`;
    
    data.forEach(c => {
      html += `<tr>
        <td>${new Date(c.timestamp).toLocaleString()}</td>
        <td>${c.player_name}</td>
        <td>${c.world}</td>
        <td>${c.message}</td>
      </tr>`;
    });
    
    html += `</table>`;
    chatLogsResult.innerHTML = html;
  } catch (err) {
    chatLogsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function searchChat() {
  const keyword = chatSearchInput.value.trim();
  if (!keyword) return alert("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/chat/search?keyword=${encodeURIComponent(keyword)}&limit=20`, 
      { headers: headers() });
    if (!res.ok) throw new Error("æ¤œç´¢å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      chatLogsResult.innerHTML = `<p>ã€Œ${keyword}ã€ã«ä¸€è‡´ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>`;
      return;
    }
    
    let html = `<h3>æ¤œç´¢çµæœ: "${keyword}" ï¼ˆ${data.length}ä»¶ï¼‰</h3><table>
      <tr><th>æ™‚åˆ»</th><th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th><th>ãƒ¯ãƒ¼ãƒ«ãƒ‰</th><th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th></tr>`;
    
    data.forEach(c => {
      html += `<tr>
        <td>${new Date(c.timestamp).toLocaleString()}</td>
        <td>${c.player_name}</td>
        <td>${c.world}</td>
        <td>${c.message}</td>
      </tr>`;
    });
    
    html += `</table>`;
    chatLogsResult.innerHTML = html;
  } catch (err) {
    chatLogsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function getPlayerChat() {
  const player = chatPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/chat/player/${player}?limit=20`, { headers: headers() });
    if (!res.ok) throw new Error("å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      chatLogsResult.innerHTML = `<p>${player} ã®ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
      return;
    }
    
    let html = `<h3>${player} ã®ãƒãƒ£ãƒƒãƒˆï¼ˆ${data.length}ä»¶ï¼‰</h3><table>
      <tr><th>æ™‚åˆ»</th><th>ãƒ¯ãƒ¼ãƒ«ãƒ‰</th><th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th></tr>`;
    
    data.forEach(c => {
      html += `<tr>
        <td>${new Date(c.timestamp).toLocaleString()}</td>
        <td>${c.world}</td>
        <td>${c.message}</td>
      </tr>`;
    });
    
    html += `</table>`;
    chatLogsResult.innerHTML = html;
  } catch (err) {
    chatLogsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function getChatStats() {
  try {
    const res = await fetch(`${API}/chat/stats`, { headers: headers() });
    if (!res.ok) throw new Error("çµ±è¨ˆå–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    let html = `<h3>ãƒãƒ£ãƒƒãƒˆçµ±è¨ˆ</h3>`;
    html += `<div class="stat-card">
      <div class="small">ç·ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</div>
      <div class="stat-value">${data.total_messages}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">ä»Šæ—¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="stat-value">${data.today_messages}</div>
    </div>`;
    html += `<div class="stat-card">
      <div class="small">æœ€ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆéå»7æ—¥ï¼‰</div>
      <div class="stat-value">${data.top_chatter.player_name || 'N/A'}</div>
      <div class="small">${data.top_chatter.message_count}ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
    </div>`;
    
    chatLogsResult.innerHTML = html;
  } catch (err) {
    chatLogsResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

// ========= v1.3.9: ã‚³ãƒãƒ³ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ =========
async function createTemplate() {
  const uuid = templatePlayerUUID.value.trim();
  const name = templateName.value.trim();
  const command = templateCommand.value.trim();
  const desc = templateDesc.value.trim();
  
  if (!uuid || !name || !command) {
    alert("UUIDã€åå‰ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  try {
    const res = await fetch(`${API}/templates`, {
      method: "POST",
      headers: {
        ...headersWithUUID(uuid),
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        name: name,
        command: command,
        description: desc || null
      })
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || "ä½œæˆå¤±æ•—");
    }
    
    templateResult.innerHTML = `<span style="color:green">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ</span>`;
    templateName.value = "";
    templateCommand.value = "";
    templateDesc.value = "";
  } catch (err) {
    templateResult.innerHTML = `<span style="color:red">${err.message}</span>`;
  }
}

async function getTemplates() {
  const uuid = prompt("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼UUIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  if (!uuid) return;
  
  try {
    const res = await fetch(`${API}/templates`, {
      headers: headersWithUUID(uuid)
    });
    
    if (!res.ok) throw new Error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.length === 0) {
      templatesResult.innerHTML = "<p>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>";
      return;
    }
    
    let html = `<h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ï¼ˆ${data.length}ä»¶ï¼‰</h3><table>
      <tr><th>åå‰</th><th>ã‚³ãƒãƒ³ãƒ‰</th><th>èª¬æ˜</th><th>ä½œæˆæ—¥æ™‚</th></tr>`;
    
    data.forEach(t => {
      html += `<tr>
        <td>${t.name}</td>
        <td><code>${t.command}</code></td>
        <td>${t.description || '-'}</td>
        <td>${new Date(t.created).toLocaleString()}</td>
      </tr>`;
    });
    
    html += `</table>`;
    templatesResult.innerHTML = html;
  } catch (err) {
    templatesResult.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

// ========= æ—¢å­˜æ©Ÿèƒ½ï¼ˆçœç•¥å¯èƒ½ - å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰ =========
// Whitelist, OP, Plugins, Console, Upload, Backup, etc.
// ï¼ˆå‰ã®index.htmlã¨åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼‰

async function whitelistAdd() {
  const player = whitelistPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const res = await fetch(`${API}/whitelist/add/${player}`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
  loadWhitelist();
}

async function whitelistRemove() {
  const player = whitelistPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const res = await fetch(`${API}/whitelist/remove/${player}`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
  loadWhitelist();
}

async function whitelistEnable() {
  const res = await fetch(`${API}/whitelist/enable`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
}

async function whitelistDisable() {
  const res = await fetch(`${API}/whitelist/disable`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
}

async function loadWhitelist() {
  const res = await fetch(`${API}/whitelist`, { headers: headers() });
  const data = await res.json();
  
  if (data.players.length === 0) {
    whitelistList.innerHTML = "<p>ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã¯ç©ºã§ã™</p>";
  } else {
    whitelistList.innerHTML = `
      <h3>ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:</h3>
      <ul>
        ${data.players.map(p => `<li>${p}</li>`).join('')}
      </ul>
    `;
  }
}

async function opAdd() {
  const player = opPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/op/add/${player}`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("OPä»˜ä¸å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    opResult.innerText = data.output;
    opResult.style.color = "green";
  } catch (err) {
    opResult.innerText = err.message;
    opResult.style.color = "red";
  }
}

async function opRemove() {
  const player = opPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/op/remove/${player}`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("OPå‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    opResult.innerText = data.output;
    opResult.style.color = "green";
  } catch (err) {
    opResult.innerText = err.message;
    opResult.style.color = "red";
  }
}

async function loadPlugins() {
  try {
    const res = await fetch(`${API}/plugins`, { headers: headers() });
    if (!res.ok) throw new Error("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.plugins.length === 0) {
      pluginsList.innerHTML = "<p>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>";
    } else {
      let html = `<h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (${data.count}å€‹):</h3><table>
        <tr>
          <th>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å</th>
          <th>ã‚µã‚¤ã‚º (MB)</th>
          <th>æ“ä½œ</th>
        </tr>`;
      
      data.plugins.forEach(p => {
        html += `<tr>
          <td>${p.name}</td>
          <td>${p.size_mb}</td>
          <td><button class="btn-danger" onclick="deletePlugin('${p.name}')">å‰Šé™¤</button></td>
        </tr>`;
      });
      
      html += "</table>";
      pluginsList.innerHTML = html;
    }
  } catch (err) {
    pluginsList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function uploadPlugin() {
  const file = pluginFileInput.files[0];
  if (!file) {
    alert("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«(.jar)ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  
  if (!file.name.endsWith(".jar")) {
    alert(".jarãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™");
    return;
  }
  
  try {
    const form = new FormData();
    form.append("file", file);
    
    const res = await fetch(`${API}/plugins/upload`, {
      method: "POST",
      headers: headers(),
      body: form
    });
    
    if (!res.ok) {
      throw new Error("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    pluginResult.innerHTML = `
      <strong>${data.plugin}</strong> ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ<br>
      <small>â€» ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ãŒå¿…è¦ã§ã™</small>
    `;
    pluginResult.style.color = "green";
    
    loadPlugins();
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

async function deletePlugin(filename) {
  if (!confirm(`${filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  
  try {
    const res = await fetch(`${API}/plugins/${filename}`, {
      method: "DELETE",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("å‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    pluginResult.innerHTML = `${filename} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ<br><small>â€» ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ãŒå¿…è¦ã§ã™</small>`;
    pluginResult.style.color = "green";
    
    loadPlugins();
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

async function reloadPlugins() {
  try {
    const res = await fetch(`${API}/plugins/reload`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("ãƒªãƒ­ãƒ¼ãƒ‰å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    pluginResult.innerText = `ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒ­ãƒ¼ãƒ‰çµæœ:\n${data.output}`;
    pluginResult.style.color = "green";
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

async function loadApiKeys() {
  try {
    const res = await fetch(`${API}/auth/keys`, { headers: headers() });
    if (!res.ok) throw new Error("Rootæ¨©é™ãŒå¿…è¦ã§ã™");
    
    const keys = await res.json();
    
    let html = `<table>
      <tr>
        <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</th>
        <th>Role</th>
        <th>ä½œæˆæ—¥æ™‚</th>
        <th>æ“ä½œ</th>
      </tr>`;
    
    keys.forEach(k => {
      html += `<tr>
        <td>${k.player_name || "N/A"}</td>
        <td>${k.role}</td>
        <td>${k.created}</td>
        <td><button class="btn-danger" onclick="deleteApiKey('${k.api_key}')">å‰Šé™¤</button></td>
      </tr>`;
    });
    
    html += "</table>";
    apiKeysList.innerHTML = html;
  } catch (err) {
    apiKeysList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function deleteApiKey(key) {
  if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  
  await fetch(`${API}/auth/keys/${key}`, {
    method: "DELETE",
    headers: headers()
  });
  
  loadApiKeys();
}

async function control(action){
  await fetch(`${API}/${action}`, {method:"POST", headers:headers()});
  getStatus();
}

async function getStatus(){
  try{
    const res = await fetch(`${API}/status`,{headers:headers()});
    const data = await res.json();
    statusEl.innerText = "Status: "+data.status;
    statusEl.className = data.status.includes("Up")?"status-running":"status-stopped";
  }catch{
    statusEl.innerText="Status: API unreachable";
    statusEl.className="status-stopped";
  }
}

async function sendCommand(){
  const cmd=cmdInput.value.trim();
  if(!cmd) return;
  const form = new FormData();
  form.append("command",cmd);
  const res = await fetch(`${API}/exec`,{method:"POST", headers:headers(), body:form});
  const data = await res.json();
  cmdOutput.value += `> ${data.command}\n${data.output}\n\n`;
  cmdOutput.scrollTop = cmdOutput.scrollHeight;
  cmdInput.value="";
}

async function loadHistory(){
  const res = await fetch(`${API}/exec/history`,{headers:headers()});
  const list = await res.json();
  cmdOutput.value="";
  list.forEach(e=>cmdOutput.value+=`[${e.time}]\n> ${e.command}\n${e.output}\n\n`);
}

async function upload(){
  const files=fileInput.files;
  if(!files.length) return alert("ãƒ•ã‚¡ã‚¤ãƒ« or ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„");
  for(const file of files){
    const form = new FormData();
    form.append("file", file, file.webkitRelativePath||file.name);
    await fetch(`${API}/upload`,{method:"POST",headers:headers(),body:form});
  }
  uploadResult.innerText="Upload completed & server restarted";
  uploadResult.style.color="green";
}

async function backup(){
  const res = await fetch(`${API}/backup`,{method:"POST", headers:headers()});
  const data = await res.json();
  backupResult.innerHTML = `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†<br>ãƒ•ã‚¡ã‚¤ãƒ«: ${data.backup}<br>ã‚µã‚¤ã‚º: ${data.size_mb} MB`;
  backupResult.style.color = "green";
  loadBackups();
}

async function loadBackups() {
  try {
    const res = await fetch(`${API}/backups`, { headers: headers() });
    if (!res.ok) throw new Error("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.backups.length === 0) {
      backupsList.innerHTML = "<p>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</p>";
    } else {
      let html = `<h4>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ« (${data.count}å€‹):</h4><table>
        <tr>
          <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
          <th>ã‚µã‚¤ã‚º (MB)</th>
          <th>ä½œæˆæ—¥æ™‚</th>
          <th>æ“ä½œ</th>
        </tr>`;
      
      data.backups.forEach(b => {
        html += `<tr>
          <td>${b.name}</td>
          <td>${b.size_mb}</td>
          <td>${new Date(b.created).toLocaleString()}</td>
          <td>
            <button class="btn-success" onclick="restoreBackup('${b.name}')">å¾©å…ƒ</button>
            <button class="btn-danger" onclick="deleteBackup('${b.name}')">å‰Šé™¤</button>
          </td>
        </tr>`;
      });
      
      html += "</table>";
      backupsList.innerHTML = html;
    }
  } catch (err) {
    backupsList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function restoreBackup(filename) {
  if (!confirm(`${filename} ã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ pre_restore ã¨ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™`)) {
    return;
  }
  
  try {
    backupResult.innerText = "ãƒªã‚¹ãƒˆã‚¢ä¸­... (ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ã„ã¾ã™)";
    backupResult.style.color = "orange";
    
    const res = await fetch(`${API}/backups/restore/${filename}`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("ãƒªã‚¹ãƒˆã‚¢å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    backupResult.innerHTML = `
      <strong>ãƒªã‚¹ãƒˆã‚¢å®Œäº†</strong><br>
      å¾©å…ƒå…ƒ: ${data.backup}<br>
      ç¾ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ${data.pre_restore_backup}<br>
      <small>â€» ã‚µãƒ¼ãƒãƒ¼ãŒå†èµ·å‹•ã•ã‚Œã¾ã—ãŸ</small>
    `;
    backupResult.style.color = "green";
  } catch (err) {
    backupResult.innerText = err.message;
    backupResult.style.color = "red";
  }
}

async function deleteBackup(filename) {
  if (!confirm(`${filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  
  try {
    const res = await fetch(`${API}/backups/${filename}`, {
      method: "DELETE",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("å‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    backupResult.innerText = `${filename} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`;
    backupResult.style.color = "green";
    loadBackups();
  } catch (err) {
    backupResult.innerText = err.message;
    backupResult.style.color = "red";
  }
}

async function createSchedule() {
  const name = scheduleName.value.trim();
  const cron = cronExpression.value.trim();
  const max = parseInt(maxBackups.value);
  
  if (!name || !cron) {
    alert("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åã¨cronå¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  try {
    const res = await fetch(`${API}/backup/schedules`, {
      method: "POST",
      headers: {
        ...headers(),
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        name: name,
        cron_expression: cron,
        max_backups: max
      })
    });
    
    if (!res.ok) {
      throw new Error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆå¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    scheduleResult.innerHTML = `
      <strong>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆå®Œäº†</strong><br>
      åå‰: ${data.name}<br>
      cron: ${data.cron_expression}<br>
      ä¿æŒä¸–ä»£: ${data.max_backups}
    `;
    scheduleResult.style.color = "green";
    
    scheduleName.value = "";
    cronExpression.value = "";
    
    loadSchedules();
  } catch (err) {
    scheduleResult.innerText = err.message;
    scheduleResult.style.color = "red";
  }
}

async function loadSchedules() {
  try {
    const res = await fetch(`${API}/backup/schedules`, { headers: headers() });
    if (!res.ok) throw new Error("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€è¦§å–å¾—å¤±æ•—");
    
    const schedules = await res.json();
    
    if (schedules.length === 0) {
      schedulesList.innerHTML = "<p>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>";
    } else {
      let html = `<h4>ç™»éŒ²æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (${schedules.length}å€‹):</h4><table>
        <tr>
          <th>åå‰</th>
          <th>cronå¼</th>
          <th>ä¿æŒä¸–ä»£</th>
          <th>çŠ¶æ…‹</th>
          <th>æœ€çµ‚å®Ÿè¡Œ</th>
          <th>æ“ä½œ</th>
        </tr>`;
      
      schedules.forEach(s => {
        const statusText = s.enabled ? "æœ‰åŠ¹" : "ç„¡åŠ¹";
        const statusColor = s.enabled ? "green" : "gray";
        const toggleText = s.enabled ? "ç„¡åŠ¹åŒ–" : "æœ‰åŠ¹åŒ–";
        const lastRun = s.last_run ? new Date(s.last_run).toLocaleString() : "æœªå®Ÿè¡Œ";
        
        html += `<tr>
          <td>${s.name}</td>
          <td>${s.cron_expression}</td>
          <td>${s.max_backups}ä¸–ä»£</td>
          <td style="color:${statusColor};font-weight:bold">${statusText}</td>
          <td>${lastRun}</td>
          <td>
            <button onclick="toggleSchedule(${s.id})">${toggleText}</button>
            <button class="btn-danger" onclick="deleteSchedule(${s.id})">å‰Šé™¤</button>
          </td>
        </tr>`;
      });
      
      html += "</table>";
      
      html += `
        <div class="small" style="margin-top:10px">
          <strong>cronå¼ã®ä¾‹:</strong><br>
          ãƒ» 0 2 * * * â†’ æ¯æ—¥2æ™‚<br>
          ãƒ» 0 */6 * * * â†’ 6æ™‚é–“ã”ã¨<br>
          ãƒ» 0 0 * * 0 â†’ æ¯é€±æ—¥æ›œ0æ™‚<br>
          ãƒ» 0 0 1 * * â†’ æ¯æœˆ1æ—¥0æ™‚
        </div>
      `;
      
      schedulesList.innerHTML = html;
    }
  } catch (err) {
    schedulesList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function toggleSchedule(id) {
  try {
    const res = await fetch(`${API}/backup/schedules/${id}/toggle`, {
      method: "PATCH",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("åˆ‡ã‚Šæ›¿ãˆå¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    loadSchedules();
  } catch (err) {
    alert(err.message);
  }
}

async function deleteSchedule(id) {
  if (!confirm("ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  
  try {
    const res = await fetch(`${API}/backup/schedules/${id}`, {
      method: "DELETE",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("å‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    scheduleResult.innerText = "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ";
    scheduleResult.style.color = "green";
    loadSchedules();
  } catch (err) {
    scheduleResult.innerText = err.message;
    scheduleResult.style.color = "red";
  }
}

async function getLogs(){
  const res = await fetch(`${API}/logs`,{headers:headers()});
  const data = await res.json();
  logsResult.value=data.logs||"";
  logsResult.scrollTop=logsResult.scrollHeight;
}

async function getMetrics(){
  const res = await fetch(`${API}/metrics`,{headers:headers()});
  metricsResult.textContent=JSON.stringify(await res.json(),null,2);
}

async function getAuditLogs(){
  const res = await fetch(`${API}/audit/logs`,{headers:headers()});
  if(!res.ok){ auditResult.textContent="æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆroot API Key ãŒå¿…è¦ï¼‰"; return; }
  const logs = await res.json();
  auditResult.textContent = logs.map(l=>`[${l.time}] (${l.role}) ${l.action}\n  detail: ${l.detail}\n  ip: ${l.ip}\n`).join("\n");
}

async function loadPlayers(){
  const res = await fetch(`${API}/players`,{headers:headers()});
  if(!res.ok){ alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å–å¾—å¤±æ•—"); return; }
  const data = await res.json();
  playerSelect.innerHTML='<option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>';
  data.players.forEach(p=>{ const opt=document.createElement("option"); opt.value=p; opt.innerText=p; playerSelect.appendChild(opt); });
  playerDetail.textContent=`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.count}`;
}

async function showPlayerDetail(){
  const name=playerSelect.value;
  if(!name){ playerDetail.textContent=""; return; }
  const res=await fetch(`${API}/players/${name}`,{headers:headers()});
  if(!res.ok){ playerDetail.textContent="è©³ç´°å–å¾—å¤±æ•—ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‹ã‚‚ï¼‰"; return; }
  const data=await res.json();
  playerDetail.textContent=JSON.stringify(data.raw_nbt,null,2);
}

setInterval(()=>{ if(apiKey()) loadPlayers(); },5000);

/* ========= Init ========= */
apiKeyInput.value = apiKey();
getStatus();
loadMyInfo();
if (apiKey()) {
  loadBackups();
  loadSchedules();
}
</script>

</body>
</html>
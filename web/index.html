<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Minecraft Server Controller</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 820px;
  margin: 40px auto;
  padding: 20px;
}
h1, h2 {
  text-align: center;
}
.section {
  margin: 20px 0;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
}
button {
  margin: 5px;
  padding: 8px 16px;
  cursor: pointer;
}
input[type="text"] {
  width: 80%;
  padding: 6px;
}
textarea {
  width: 100%;
  height: 220px;
  margin-top: 10px;
  white-space: pre-wrap;
}
pre {
  background: #f7f7f7;
  padding: 10px;
  border-radius: 6px;
  max-height: 300px;
  overflow: auto;
}
.status-running {
  color: green;
  font-weight: bold;
}
.status-stopped {
  color: red;
  font-weight: bold;
}
.small {
  font-size: 0.85em;
  color: #666;
}
</style>
</head>

<body>

<h1>ğŸŸ© Minecraft Server Controller</h1>

<!-- API KEY -->
<div class="section">
<h2>ğŸ” API Key</h2>
<input type="text" id="apiKeyInput" placeholder="X-API-Key">
<button onclick="saveKey()">Save</button>
<p class="small">â€» localStorage ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
</div>

<!-- Server Control -->
<div class="section">
<h2>âš™ Server Control</h2>
<button onclick="control('start')">Start</button>
<button onclick="control('stop')">Stop</button>
<button onclick="getStatus()">Status</button>
<p id="status">Status: Unknown</p>
</div>

<!-- Console -->
<div class="section">
<h2>ğŸ’» Server Console</h2>
<input type="text" id="cmdInput" placeholder="ä¾‹: say Hello">
<button onclick="sendCommand()">Send</button>
<button onclick="loadHistory()">Load History</button>
<textarea id="cmdOutput" readonly></textarea>
</div>

<!-- Upload -->
<div class="section">
<h2>ğŸ“¦ Upload File / Folder</h2>
<input type="file" id="fileInput" webkitdirectory directory multiple>
<button onclick="upload()">Upload</button>
<p id="uploadResult"></p>
</div>

<!-- Backup -->
<div class="section">
<h2>ğŸ’¾ Backup</h2>
<button onclick="backup()">Create Backup</button>
<p id="backupResult"></p>
</div>

<!-- Logs -->
<div class="section">
<h2>ğŸ“œ Minecraft Logs</h2>
<button onclick="getLogs()">Refresh</button>
<textarea id="logsResult" readonly></textarea>
</div>

<!-- Metrics -->
<div class="section">
<h2>ğŸ“Š Server Metrics</h2>
<button onclick="getMetrics()">Load</button>
<pre id="metricsResult"></pre>
</div>

<!-- Audit Logs -->
<div class="section">
<h2>ğŸ•µ æ“ä½œãƒ­ã‚°ï¼ˆAudit Logsï¼‰</h2>
<button onclick="getAuditLogs()">Load</button>
<pre id="auditResult">root API Key ã§ã®ã¿è¡¨ç¤ºå¯èƒ½</pre>
</div>

<script>
const API = "http://localhost:8000";

/* ========= API KEY ========= */
function apiKey() {
  return localStorage.getItem("apiKey") || "";
}
function headers() {
  return { "X-API-Key": apiKey() };
}
function saveKey() {
  const key = apiKeyInput.value.trim();
  if (!key) return alert("API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  localStorage.setItem("apiKey", key);
  alert("API Key saved");
}

/* ========= Server ========= */
async function control(action) {
  await fetch(`${API}/${action}`, { method: "POST", headers: headers() });
  getStatus();
}
async function getStatus() {
  try {
    const res = await fetch(`${API}/status`, { headers: headers() });
    const data = await res.json();
    const el = document.getElementById("status");
    el.innerText = "Status: " + data.status;
    el.className = data.status.includes("Up")
      ? "status-running"
      : "status-stopped";
  } catch {
    status.innerText = "Status: API unreachable";
    status.className = "status-stopped";
  }
}

/* ========= Console ========= */
async function sendCommand() {
  const cmd = cmdInput.value.trim();
  if (!cmd) return;
  const form = new FormData();
  form.append("command", cmd);
  const res = await fetch(`${API}/exec`, {
    method: "POST",
    headers: headers(),
    body: form
  });
  const data = await res.json();
  cmdOutput.value += `> ${data.command}\n${data.output}\n\n`;
  cmdOutput.scrollTop = cmdOutput.scrollHeight;
  cmdInput.value = "";
}
async function loadHistory() {
  const res = await fetch(`${API}/exec/history`, { headers: headers() });
  const list = await res.json();
  cmdOutput.value = "";
  list.forEach(e => {
    cmdOutput.value += `[${e.time}]\n> ${e.command}\n${e.output}\n\n`;
  });
}

/* ========= Upload ========= */
async function upload() {
  const files = fileInput.files;
  if (!files.length) return alert("ãƒ•ã‚¡ã‚¤ãƒ« or ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„");
  for (const file of files) {
    const form = new FormData();
    form.append("file", file, file.webkitRelativePath || file.name);
    await fetch(`${API}/upload`, {
      method: "POST",
      headers: headers(),
      body: form
    });
  }
  uploadResult.innerText = "Upload completed & server restarted";
  uploadResult.style.color = "green";
}

/* ========= Backup ========= */
async function backup() {
  const res = await fetch(`${API}/backup`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  backupResult.innerText = data.backup;
}

/* ========= Logs ========= */
async function getLogs() {
  const res = await fetch(`${API}/logs`, { headers: headers() });
  const data = await res.json();
  logsResult.value = data.logs || "";
  logsResult.scrollTop = logsResult.scrollHeight;
}

/* ========= Metrics ========= */
async function getMetrics() {
  const res = await fetch(`${API}/metrics`, { headers: headers() });
  metricsResult.textContent = JSON.stringify(await res.json(), null, 2);
}

/* ========= Audit Logs ========= */
async function getAuditLogs() {
  const res = await fetch(`${API}/audit/logs`, { headers: headers() });
  if (!res.ok) {
    auditResult.textContent = "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆroot API Key ãŒå¿…è¦ï¼‰";
    return;
  }
  const logs = await res.json();
  auditResult.textContent = logs.map(l =>
    `[${l.time}] (${l.role}) ${l.action}\n  detail: ${l.detail}\n  ip: ${l.ip}\n`
  ).join("\n");
}

/* ========= Init ========= */
apiKeyInput.value = apiKey();
getStatus();
</script>

</body>
</html>

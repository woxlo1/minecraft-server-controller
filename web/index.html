<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Minecraft Server Controller</title>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 1000px;
  margin: 40px auto;
  padding: 20px;
}
h1, h2 {
  text-align: center;
}
.section {
  margin: 20px 0;
  padding: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
}
button {
  margin: 5px;
  padding: 8px 16px;
  cursor: pointer;
}
input[type="text"], select {
  width: 80%;
  padding: 6px;
  margin: 5px 0;
}
textarea {
  width: 100%;
  height: 220px;
  margin-top: 10px;
  white-space: pre-wrap;
}
pre {
  background: #f7f7f7;
  padding: 10px;
  border-radius: 6px;
  max-height: 300px;
  overflow: auto;
}
.status-running {
  color: green;
  font-weight: bold;
}
.status-stopped {
  color: red;
  font-weight: bold;
}
.small {
  font-size: 0.85em;
  color: #666;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
table th, table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
table th {
  background-color: #f2f2f2;
}
.btn-danger {
  background-color: #dc3545;
  color: white;
  border: none;
}
.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
}
.hidden {
  display: none;
}
</style>
</head>

<body>

<h1>ğŸŸ© Minecraft Server Controller v4.0</h1>

<!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åç™»éŒ² -->
<div class="section" id="playerRegisterSection">
<h2>ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ²</h2>
<p>åˆã‚ã¦ã®æ–¹ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„</p>
<input type="text" id="playerNameInput" placeholder="Minecraftãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<select id="roleSelect">
  <option value="player">Playerï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</option>
  <option value="admin">Adminï¼ˆç®¡ç†è€…ï¼‰</option>
</select>
<button onclick="registerPlayer()" class="btn-success">ç™»éŒ²ã—ã¦APIã‚­ãƒ¼å–å¾—</button>
<p id="registerResult"></p>
</div>

<!-- API KEY -->
<div class="section">
<h2>ğŸ”‘ API Key</h2>
<input type="text" id="apiKeyInput" placeholder="X-API-Key">
<button onclick="saveKey()">ä¿å­˜</button>
<button onclick="loadMyInfo()">è‡ªåˆ†ã®æƒ…å ±ã‚’ç¢ºèª</button>
<p class="small">â€» localStorageã«ä¿å­˜ã•ã‚Œã¾ã™</p>
<div id="myInfo"></div>
</div>

<!-- Server Control -->
<div class="section">
<h2>âš™ Server Control</h2>
<button onclick="control('start')">Start</button>
<button onclick="control('stop')">Stop</button>
<button onclick="getStatus()">Status</button>
<p id="status">Status: Unknown</p>
</div>

<!-- Whitelist ç®¡ç† -->
<div class="section">
<h2>ğŸ“‹ Whitelist ç®¡ç†</h2>
<input type="text" id="whitelistPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="whitelistAdd()" class="btn-success">è¿½åŠ </button>
<button onclick="whitelistRemove()" class="btn-danger">å‰Šé™¤</button>
<button onclick="whitelistEnable()" class="btn-success">æœ‰åŠ¹åŒ–</button>
<button onclick="whitelistDisable()" class="btn-danger">ç„¡åŠ¹åŒ–</button>
<button onclick="loadWhitelist()">ãƒªã‚¹ãƒˆè¡¨ç¤º</button>
<p id="whitelistResult"></p>
<div id="whitelistList"></div>
</div>

<!-- Operator ç®¡ç† -->
<div class="section">
<h2>ğŸ‘‘ Operator ç®¡ç†</h2>
<p class="small">â€» ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</p>
<input type="text" id="opPlayerInput" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
<button onclick="opAdd()" class="btn-success">OPä»˜ä¸</button>
<button onclick="opRemove()" class="btn-danger">OPå‰Šé™¤</button>
<p id="opResult"></p>
</div>

<!-- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† -->
<div class="section">
<h2>ğŸ”Œ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ï¼ˆPAPER/SPIGOTç”¨ï¼‰</h2>
<p class="small">â€» ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</p>
<button onclick="loadPlugins()">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§</button>
<button onclick="reloadPlugins()">ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒ­ãƒ¼ãƒ‰</button>
<div id="pluginsList"></div>
<hr>
<h3>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
<input type="file" id="pluginFileInput" accept=".jar">
<button onclick="uploadPlugin()" class="btn-success">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
<p id="pluginResult"></p>
</div>

<!-- Console -->
<div class="section">
<h2>ğŸ’» Server Console</h2>
<input type="text" id="cmdInput" placeholder="ä¾‹: say Hello">
<button onclick="sendCommand()">Send</button>
<button onclick="loadHistory()">Load History</button>
<textarea id="cmdOutput" readonly></textarea>
</div>

<!-- Upload -->
<div class="section">
<h2>ğŸ“¦ Upload File / Folder</h2>
<input type="file" id="fileInput" webkitdirectory directory multiple>
<button onclick="upload()">Upload</button>
<p id="uploadResult"></p>
</div>

<!-- Backup -->
<div class="section">
<h2>ğŸ’¾ Backup</h2>
<button onclick="backup()">Create Backup</button>
<p id="backupResult"></p>
</div>

<!-- Logs -->
<div class="section">
<h2>ğŸ“œ Minecraft Logs</h2>
<button onclick="getLogs()">Refresh</button>
<textarea id="logsResult" readonly></textarea>
</div>

<!-- Metrics -->
<div class="section">
<h2>ğŸ“Š Server Metrics</h2>
<button onclick="getMetrics()">Load</button>
<pre id="metricsResult"></pre>
</div>

<!-- API Keys ç®¡ç†ï¼ˆRootç”¨ï¼‰ -->
<div class="section" id="apiKeysSection">
<h2>ğŸ” API Keys ç®¡ç†ï¼ˆRootå°‚ç”¨ï¼‰</h2>
<button onclick="loadApiKeys()">APIã‚­ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º</button>
<div id="apiKeysList"></div>
</div>

<!-- Audit Logs -->
<div class="section">
<h2>ğŸ•µ æ“ä½œãƒ­ã‚°ï¼ˆAudit Logsï¼‰</h2>
<button onclick="getAuditLogs()">Load</button>
<pre id="auditResult">root API Key ã§ã®ã¿è¡¨ç¤ºå¯èƒ½</pre>
</div>

<!-- Players -->
<div class="section">
  <h2>ğŸ§‘â€ğŸ’» Players</h2>
  <button onclick="loadPlayers()">Load Online Players</button>
  <select id="playerSelect" onchange="showPlayerDetail()">
    <option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>
  </select>
  <pre id="playerDetail"></pre>
</div>

<script>
const API = "http://localhost:8000";

// DOM Elements
const apiKeyInput = document.getElementById("apiKeyInput");
const playerNameInput = document.getElementById("playerNameInput");
const roleSelect = document.getElementById("roleSelect");
const registerResult = document.getElementById("registerResult");
const myInfo = document.getElementById("myInfo");
const whitelistPlayerInput = document.getElementById("whitelistPlayerInput");
const whitelistResult = document.getElementById("whitelistResult");
const whitelistList = document.getElementById("whitelistList");
const opPlayerInput = document.getElementById("opPlayerInput");
const opResult = document.getElementById("opResult");
const pluginFileInput = document.getElementById("pluginFileInput");
const pluginsList = document.getElementById("pluginsList");
const pluginResult = document.getElementById("pluginResult");
const cmdInput = document.getElementById("cmdInput");
const cmdOutput = document.getElementById("cmdOutput");
const fileInput = document.getElementById("fileInput");
const uploadResult = document.getElementById("uploadResult");
const backupResult = document.getElementById("backupResult");
const logsResult = document.getElementById("logsResult");
const metricsResult = document.getElementById("metricsResult");
const auditResult = document.getElementById("auditResult");
const statusEl = document.getElementById("status");
const playerSelect = document.getElementById("playerSelect");
const playerDetail = document.getElementById("playerDetail");
const apiKeysList = document.getElementById("apiKeysList");

// ========= API Key =========
function apiKey() { return localStorage.getItem("apiKey")||""; }
function headers() { return { "X-API-Key": apiKey() }; }
function saveKey() {
  const key = apiKeyInput.value.trim();
  if(!key) return alert("API Key ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  localStorage.setItem("apiKey", key);
  alert("API Key saved");
  loadMyInfo();
}

// ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç™»éŒ² =========
async function registerPlayer() {
  const playerName = playerNameInput.value.trim();
  const role = roleSelect.value;
  
  if (!playerName) {
    alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  // Root API KeyãŒå¿…è¦
  const rootKey = prompt("Root API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  if (!rootKey) return;
  
  try {
    const res = await fetch(`${API}/auth/keys`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Key": rootKey
      },
      body: JSON.stringify({
        player_name: playerName,
        role: role
      })
    });
    
    if (!res.ok) {
      throw new Error("API Keyä½œæˆå¤±æ•—: Rootæ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    registerResult.innerHTML = `
      <strong>ç™»éŒ²å®Œäº†ï¼</strong><br>
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: ${data.player_name}<br>
      Role: ${data.role}<br>
      API Key: <code>${data.api_key}</code><br>
      <small>â€» ã“ã®APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ï¼ˆå†è¡¨ç¤ºã§ãã¾ã›ã‚“ï¼‰</small>
    `;
    registerResult.style.color = "green";
    
    // è‡ªå‹•ã§å…¥åŠ›
    apiKeyInput.value = data.api_key;
  } catch (err) {
    registerResult.innerText = err.message;
    registerResult.style.color = "red";
  }
}

// ========= è‡ªåˆ†ã®æƒ…å ±ç¢ºèª =========
async function loadMyInfo() {
  if (!apiKey()) {
    myInfo.innerText = "";
    return;
  }
  
  try {
    const res = await fetch(`${API}/auth/keys/my`, { headers: headers() });
    if (!res.ok) throw new Error("èªè¨¼å¤±æ•—");
    
    const data = await res.json();
    myInfo.innerHTML = `
      <strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong><br>
      ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: ${data.player_name || "ç®¡ç†è€…"}<br>
      Role: ${data.role}
    `;
  } catch (err) {
    myInfo.innerText = "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

// ========= Whitelist =========
async function whitelistAdd() {
  const player = whitelistPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const res = await fetch(`${API}/whitelist/add/${player}`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
  loadWhitelist();
}

async function whitelistRemove() {
  const player = whitelistPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  const res = await fetch(`${API}/whitelist/remove/${player}`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
  loadWhitelist();
}

async function whitelistEnable() {
  const res = await fetch(`${API}/whitelist/enable`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
}

async function whitelistDisable() {
  const res = await fetch(`${API}/whitelist/disable`, {
    method: "POST",
    headers: headers()
  });
  const data = await res.json();
  whitelistResult.innerText = data.output;
}

async function loadWhitelist() {
  const res = await fetch(`${API}/whitelist`, { headers: headers() });
  const data = await res.json();
  
  if (data.players.length === 0) {
    whitelistList.innerHTML = "<p>ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã¯ç©ºã§ã™</p>";
  } else {
    whitelistList.innerHTML = `
      <h3>ç™»éŒ²æ¸ˆã¿ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:</h3>
      <ul>
        ${data.players.map(p => `<li>${p}</li>`).join('')}
      </ul>
    `;
  }
}

// ========= Operator =========
async function opAdd() {
  const player = opPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/op/add/${player}`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("OPä»˜ä¸å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    opResult.innerText = data.output;
    opResult.style.color = "green";
  } catch (err) {
    opResult.innerText = err.message;
    opResult.style.color = "red";
  }
}

async function opRemove() {
  const player = opPlayerInput.value.trim();
  if (!player) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  try {
    const res = await fetch(`${API}/op/remove/${player}`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("OPå‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    opResult.innerText = data.output;
    opResult.style.color = "green";
  } catch (err) {
    opResult.innerText = err.message;
    opResult.style.color = "red";
  }
}

// ========= ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç† =========
async function loadPlugins() {
  try {
    const res = await fetch(`${API}/plugins`, { headers: headers() });
    if (!res.ok) throw new Error("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§å–å¾—å¤±æ•—");
    
    const data = await res.json();
    
    if (data.plugins.length === 0) {
      pluginsList.innerHTML = "<p>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>";
    } else {
      let html = `<h3>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (${data.count}å€‹):</h3><table>
        <tr>
          <th>ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å</th>
          <th>ã‚µã‚¤ã‚º (MB)</th>
          <th>æ“ä½œ</th>
        </tr>`;
      
      data.plugins.forEach(p => {
        html += `<tr>
          <td>${p.name}</td>
          <td>${p.size_mb}</td>
          <td><button class="btn-danger" onclick="deletePlugin('${p.name}')">å‰Šé™¤</button></td>
        </tr>`;
      });
      
      html += "</table>";
      pluginsList.innerHTML = html;
    }
  } catch (err) {
    pluginsList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function uploadPlugin() {
  const file = pluginFileInput.files[0];
  if (!file) {
    alert("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«(.jar)ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }
  
  if (!file.name.endsWith(".jar")) {
    alert(".jarãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™");
    return;
  }
  
  try {
    const form = new FormData();
    form.append("file", file);
    
    const res = await fetch(`${API}/plugins/upload`, {
      method: "POST",
      headers: headers(),
      body: form
    });
    
    if (!res.ok) {
      throw new Error("ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    pluginResult.innerHTML = `
      <strong>${data.plugin}</strong> ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ<br>
      <small>â€» ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ãŒå¿…è¦ã§ã™</small>
    `;
    pluginResult.style.color = "green";
    
    loadPlugins();
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

async function deletePlugin(filename) {
  if (!confirm(`${filename} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  
  try {
    const res = await fetch(`${API}/plugins/${filename}`, {
      method: "DELETE",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("å‰Šé™¤å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    pluginResult.innerHTML = `${filename} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ<br><small>â€» ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ãŒå¿…è¦ã§ã™</small>`;
    pluginResult.style.color = "green";
    
    loadPlugins();
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

async function reloadPlugins() {
  try {
    const res = await fetch(`${API}/plugins/reload`, {
      method: "POST",
      headers: headers()
    });
    
    if (!res.ok) {
      throw new Error("ãƒªãƒ­ãƒ¼ãƒ‰å¤±æ•—: ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™");
    }
    
    const data = await res.json();
    pluginResult.innerText = `ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒªãƒ­ãƒ¼ãƒ‰çµæœ:\n${data.output}`;
    pluginResult.style.color = "green";
  } catch (err) {
    pluginResult.innerText = err.message;
    pluginResult.style.color = "red";
  }
}

// ========= API Keys ç®¡ç† =========
async function loadApiKeys() {
  try {
    const res = await fetch(`${API}/auth/keys`, { headers: headers() });
    if (!res.ok) throw new Error("Rootæ¨©é™ãŒå¿…è¦ã§ã™");
    
    const keys = await res.json();
    
    let html = `<table>
      <tr>
        <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</th>
        <th>Role</th>
        <th>ä½œæˆæ—¥æ™‚</th>
        <th>æ“ä½œ</th>
      </tr>`;
    
    keys.forEach(k => {
      html += `<tr>
        <td>${k.player_name || "N/A"}</td>
        <td>${k.role}</td>
        <td>${k.created}</td>
        <td><button class="btn-danger" onclick="deleteApiKey('${k.api_key}')">å‰Šé™¤</button></td>
      </tr>`;
    });
    
    html += "</table>";
    apiKeysList.innerHTML = html;
  } catch (err) {
    apiKeysList.innerHTML = `<p style="color:red">${err.message}</p>`;
  }
}

async function deleteApiKey(key) {
  if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  
  await fetch(`${API}/auth/keys/${key}`, {
    method: "DELETE",
    headers: headers()
  });
  
  loadApiKeys();
}

// ========= Server =========
async function control(action){
  await fetch(`${API}/${action}`, {method:"POST", headers:headers()});
  getStatus();
}
async function getStatus(){
  try{
    const res = await fetch(`${API}/status`,{headers:headers()});
    const data = await res.json();
    statusEl.innerText = "Status: "+data.status;
    statusEl.className = data.status.includes("Up")?"status-running":"status-stopped";
  }catch{
    statusEl.innerText="Status: API unreachable";
    statusEl.className="status-stopped";
  }
}

// ========= Console =========
async function sendCommand(){
  const cmd=cmdInput.value.trim();
  if(!cmd) return;
  const form = new FormData();
  form.append("command",cmd);
  const res = await fetch(`${API}/exec`,{method:"POST", headers:headers(), body:form});
  const data = await res.json();
  cmdOutput.value += `> ${data.command}\n${data.output}\n\n`;
  cmdOutput.scrollTop = cmdOutput.scrollHeight;
  cmdInput.value="";
}
async function loadHistory(){
  const res = await fetch(`${API}/exec/history`,{headers:headers()});
  const list = await res.json();
  cmdOutput.value="";
  list.forEach(e=>cmdOutput.value+=`[${e.time}]\n> ${e.command}\n${e.output}\n\n`);
}

// ========= Upload =========
async function upload(){
  const files=fileInput.files;
  if(!files.length) return alert("ãƒ•ã‚¡ã‚¤ãƒ« or ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„");
  for(const file of files){
    const form = new FormData();
    form.append("file", file, file.webkitRelativePath||file.name);
    await fetch(`${API}/upload`,{method:"POST",headers:headers(),body:form});
  }
  uploadResult.innerText="Upload completed & server restarted";
  uploadResult.style.color="green";
}

// ========= Backup =========
async function backup(){
  const res = await fetch(`${API}/backup`,{method:"POST", headers:headers()});
  const data = await res.json();
  backupResult.innerText = data.backup;
}

// ========= Logs =========
async function getLogs(){
  const res = await fetch(`${API}/logs`,{headers:headers()});
  const data = await res.json();
  logsResult.value=data.logs||"";
  logsResult.scrollTop=logsResult.scrollHeight;
}

// ========= Metrics =========
async function getMetrics(){
  const res = await fetch(`${API}/metrics`,{headers:headers()});
  metricsResult.textContent=JSON.stringify(await res.json(),null,2);
}

// ========= Audit Logs =========
async function getAuditLogs(){
  const res = await fetch(`${API}/audit/logs`,{headers:headers()});
  if(!res.ok){ auditResult.textContent="æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆroot API Key ãŒå¿…è¦ï¼‰"; return; }
  const logs = await res.json();
  auditResult.textContent = logs.map(l=>`[${l.time}] (${l.role}) ${l.action}\n  detail: ${l.detail}\n  ip: ${l.ip}\n`).join("\n");
}

// ========= Players =========
async function loadPlayers(){
  const res = await fetch(`${API}/players`,{headers:headers()});
  if(!res.ok){ alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å–å¾—å¤±æ•—"); return; }
  const data = await res.json();
  playerSelect.innerHTML='<option value="">-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ --</option>';
  data.players.forEach(p=>{ const opt=document.createElement("option"); opt.value=p; opt.innerText=p; playerSelect.appendChild(opt); });
  playerDetail.textContent=`ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${data.count}`;
}
async function showPlayerDetail(){
  const name=playerSelect.value;
  if(!name){ playerDetail.textContent=""; return; }
  const res=await fetch(`${API}/players/${name}`,{headers:headers()});
  if(!res.ok){ playerDetail.textContent="è©³ç´°å–å¾—å¤±æ•—ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‹ã‚‚ï¼‰"; return; }
  const data=await res.json();
  playerDetail.textContent=JSON.stringify(data.raw_nbt,null,2);
}

// Auto-refresh players every 5s
setInterval(()=>{ if(apiKey()) loadPlayers(); },5000);

/* ========= Init ========= */
apiKeyInput.value = apiKey();
getStatus();
loadMyInfo();
</script>

</body>
</html>